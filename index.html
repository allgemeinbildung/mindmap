<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mermaid Renderer</title>
    <style>
        body { font-family: sans-serif; text-align: center; }
        #mermaid-container { margin: 20px; }
        button { 
            padding: 10px 18px; 
            margin: 5px; 
            cursor: pointer; 
            border: 1px solid #ccc; 
            border-radius: 5px;
            background-color: #f0f0f0;
        }
        button:hover { background-color: #e0e0e0; }
        #excalidraw-btn { background-color: #d8e2ff; }
        #excalidraw-btn:hover { background-color: #c4d1f7; }
    </style>
</head>
<body>
    <h1>Mermaid Diagram</h1>
    <div id="mermaid-container"></div>
    <div id="controls">
        <button id="download-svg">Download as SVG</button>
        <button id="download-png">Download as PNG</button>
        <button id="open-in-excalidraw" id="excalidraw-btn">➡️ Open in Excalidraw</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false });

        // =========================================================================
        // NEW: A reliable helper function to encode Unicode text to Base64
        // =========================================================================
        const unicodeToBase64 = (str) => {
            const uint8Array = new TextEncoder().encode(str);
            const binaryString = String.fromCharCode.apply(null, uint8Array);
            return btoa(binaryString);
        };

        const renderDiagram = async () => {
            const container = document.getElementById('mermaid-container');
            const urlParams = new URLSearchParams(window.location.search);
            const mindmapName = urlParams.get('mindmap'); 

            if (!mindmapName) {
                container.innerHTML = "Error: No mindmap name specified in URL.";
                return;
            }

            const filePath = `./maps/${mindmapName}.json`;

            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`Mindmap file not found at ${filePath}`);
                }
                const data = await response.json();
                const mermaidCode = data.mermaidCode;

                const { svg } = await mermaid.render('mermaid-graph', mermaidCode);
                container.innerHTML = svg;
                setupButtons(svg);

            } catch (error) {
                container.innerHTML = `Error: ${error.message}`;
                console.error("Failed to load or render mindmap:", error);
            }
        };

        const setupButtons = (svgCode) => {
            // ... (download-svg and download-png functions remain the same)
            document.getElementById('download-svg').onclick = () => { /* ... no change ... */ };
            document.getElementById('download-png').onclick = async () => { /* ... no change ... */ };

            document.getElementById('open-in-excalidraw').onclick = () => {
                // Step 1: Use the new, reliable function to create Base64 data
                const base64Data = unicodeToBase64(svgCode);
                const svgDataURL = 'data:image/svg+xml;base64,' + base64Data;

                // Step 2: Create the Excalidraw library JSON structure
                const excalidrawLibrary = {
                    type: "excalidrawlib",
                    version: 2,
                    source: "https://allgemeinbildung.github.io/mindmap/",
                    libraryItems: [
                        {
                            id: "mermaid-mindmap-" + Date.now(),
                            status: "published",
                            elements: [
                                {
                                    type: "image",
                                    version: 1,
                                    versionNonce: Date.now(),
                                    isDeleted: false,
                                    id: "image-1",
                                    fillStyle: "hachure",
                                    strokeWidth: 1,
                                    strokeStyle: "solid",
                                    opacity: 100,
                                    x: 0,
                                    y: 0,
                                    width: 500,
                                    height: 500,
                                    fileId: null,
                                    dataURL: svgDataURL
                                }
                            ]
                        }
                    ]
                };

                // Step 3: URL-encode the JSON and create the final link
                const libraryData = encodeURIComponent(JSON.stringify(excalidrawLibrary));
                const excalidrawURL = `https://excalidraw.com/#addLibrary=data:application/json,${libraryData}`;
                
                // Step 4: Open the link in a new tab
                window.open(excalidrawURL, '_blank');
            };
        };

        // Run the rendering on page load
        renderDiagram();
    </script>
</body>
</html>
