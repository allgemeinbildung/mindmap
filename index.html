<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mermaid Renderer</title>
    <style>
        body { font-family: sans-serif; text-align: center; }
        #mermaid-container { margin: 20px; }
        button { 
            padding: 10px 18px; 
            margin: 5px; 
            cursor: pointer; 
            border: 1px solid #ccc; 
            border-radius: 5px;
            background-color: #f0f0f0;
        }
        button:hover { background-color: #e0e0e0; }
        #excalidraw-btn { background-color: #d8e2ff; }
        #excalidraw-btn:hover { background-color: #c4d1f7; }
    </style>
</head>
<body>
    <h1>Mermaid Diagram</h1>
    <div id="mermaid-container"></div>
    <div id="controls">
        <button id="download-svg">Download as SVG</button>
        <button id="download-png">Download as PNG</button>
        <button id="open-in-excalidraw" id="excalidraw-btn">➡️ Open in Excalidraw</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false });

        const renderDiagram = async () => {
            const container = document.getElementById('mermaid-container');
            const urlParams = new URLSearchParams(window.location.search);
            const mermaidCode = urlParams.get('mindmap');

            if (!mermaidCode) {
                container.innerHTML = "Error: No mindmap data found in URL.";
                return;
            }

            try {
                const decodedCode = decodeURIComponent(mermaidCode);
                const { svg } = await mermaid.render('mermaid-graph', decodedCode);
                container.innerHTML = svg;
                setupButtons(svg);
            } catch (error) {
                container.innerHTML = `Error rendering Mermaid diagram: ${error}`;
            }
        };

        const setupButtons = (svgCode) => {
            // Download SVG
            document.getElementById('download-svg').onclick = () => {
                const blob = new Blob([svgCode], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mindmap.svg';
                a.click();
                URL.revokeObjectURL(url);
            };

            // Download PNG
            document.getElementById('download-png').onclick = async () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const v = await canvg.Canvg.from(ctx, svgCode);
                await v.render();
                
                const dataUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = 'mindmap.png';
                a.click();
            };

            // Setup Excalidraw button with the FIX
            document.getElementById('open-in-excalidraw').onclick = () => {
                // Step 1: Create a robust SVG Data URL using encodeURIComponent
                const svgDataURL = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgCode);

                // Step 2: Create the Excalidraw library JSON structure
                const excalidrawLibrary = {
                    type: "excalidrawlib",
                    version: 2,
                    source: "https://allgemeinbildung.github.io/mindmap/",
                    libraryItems: [
                        {
                            id: "mermaid-mindmap",
                            status: "published",
                            elements: [
                                {
                                    type: "image",
                                    version: 1,
                                    versionNonce: Date.now(),
                                    isDeleted: false,
                                    id: "image-1",
                                    fillStyle: "hachure",
                                    strokeWidth: 1,
                                    strokeStyle: "solid",
                                    opacity: 100,
                                    x: 0,
                                    y: 0,
                                    width: 500,
                                    height: 500,
                                    fileId: null,
                                    dataURL: svgDataURL
                                }
                            ]
                        }
                    ]
                };

                // Step 3: URL-encode the JSON and create the final link
                const libraryData = encodeURIComponent(JSON.stringify(excalidrawLibrary));
                const excalidrawURL = `https://excalidraw.com/#addLibrary=data:application/json,${libraryData}`;
                
                // Step 4: Open the link in a new tab
                window.open(excalidrawURL, '_blank');
            };
        };

        // Run the rendering on page load
        renderDiagram();
    </script>
</body>
</html>
